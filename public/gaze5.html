<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alzheimer’s Assessment Results</title>
    <!-- TensorFlow.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Chart.js for Visualizations -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Basic Reset */
        body,
        html {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff; /* Changed to white */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        /* Container */
        .container {
            text-align: center;
            padding: 40px;
            max-width: 900px;
            background-color: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin: 20px;
            padding-bottom: 100px; /* Added padding to prevent footer overlap */
        }

        /* Header Styling */
        header h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #007BFF;
            border-bottom: 3px solid #61dafb;
            padding-bottom: 10px;
        }

        /* Result Sections */
        .result-section {
            margin: 30px 0;
        }

        .result-section h2 {
            font-size: 2em;
            margin-bottom: 15px;
            color: #007BFF;
        }

        .result {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .advice {
            font-size: 1.2em;
            margin-bottom: 30px;
            color: #555;
        }

        /* Button Styling */
        .btn {
            display: inline-block;
            padding: 15px 30px;
            font-size: 1.1em;
            color: #fff;
            background-color: #007BFF;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 20px;
        }

        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 40px auto;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            header h1 {
                font-size: 2em;
            }

            .result {
                font-size: 1.5em;
            }

            .advice {
                font-size: 1em;
            }

            .btn {
                padding: 12px 25px;
                font-size: 1em;
            }

            .chart-container {
                max-width: 100%;
            }
        }

        /* Footer Styling */
        footer {
            width: 100%;
            background: #ffffff; /* Changed to white */
            color: #777;
            padding: 15px;
            border-radius: 20px 20px 0 0;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Footer Logo Styling */
        .footer-logo {
            margin-top: 5px; /* Reduced margin */
            max-width: 40px; /* Reduced size */
        }

        @media (max-width: 768px) {
            .footer-logo {
                max-width: 30px; /* Further reduced size on mobile */
                margin-top: 4px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Alzheimer’s Assessment Results</h1>
        </header>

        <!-- Privacy Notice -->
        <div id="privacyNotice">
            <p><strong>Privacy Notice:</strong> All data is anonymized and stored securely.</p>
        </div>

        <!-- First Report: Drawing Analysis -->
        <div class="result-section" id="drawing-report">
            <h2>Drawing Analysis</h2>
            <div class="result">
                Result: <span id="drawingPrediction">Loading...</span>
            </div>
            <div class="advice" id="drawingAdvice">Please wait while we process your drawing...</div>
            <div class="chart-container">
                <canvas id="drawingChart" width="400" height="200" style="max-width: 100%;"></canvas>
            </div>
        </div>

        <!-- Second Report: Task Performance -->
        <div class="result-section" id="task-report">
            <h2>Task Performance Analysis</h2>
            <div class="result">
                Correct Answers: <span id="correctCount">0</span>
            </div>
            <div class="result">
                Wrong Answers: <span id="wrongCount">0</span>
            </div>
            <div class="result">
                Average Reaction Time: <span id="averageReactionTime">0</span> ms
            </div>
            <div class="advice" id="taskAdvice">Analyzing your task performance...</div>
            <div class="chart-container">
                <canvas id="taskChart" width="400" height="200" style="max-width: 100%;"></canvas>
            </div>
        </div>

        <!-- Combined Charts (Optional) -->
        <!-- You can uncomment and customize these if needed -->
        <!--
        <div class="chart-container">
            <canvas id="combinedChart" width="400" height="200" style="max-width: 100%;"></canvas>
        </div>
        -->

        <a href="gaze4.html" class="btn">Start Again</a>
    </div>

    <footer>
        <img src="images/logo.png" alt="Alzheimer’s Assessment Logo" class="footer-logo">
        <p>&copy; 2024 Alzheimer's Assessment Tool. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const drawingPrediction = document.getElementById('drawingPrediction');
            const drawingAdvice = document.getElementById('drawingAdvice');
            const drawingChartCtx = document.getElementById('drawingChart').getContext('2d');

            const correctCountEl = document.getElementById('correctCount');
            const wrongCountEl = document.getElementById('wrongCount');
            const averageReactionTimeEl = document.getElementById('averageReactionTime');
            const taskAdvice = document.getElementById('taskAdvice');
            const taskChartCtx = document.getElementById('taskChart').getContext('2d');

            // Function to safely retrieve data from localStorage
            function getExperimentData() {
                const data = localStorage.getItem('experimentData');
                if (data) {
                    return JSON.parse(data);
                }
                return null;
            }

            // Start the process by retrieving data and displaying results
            const experimentData = getExperimentData();
            if (experimentData) {
                displayDrawingResults(experimentData);
                displayTaskResults(experimentData);
            } else {
                drawingPrediction.textContent = 'No data available.';
                drawingAdvice.textContent = 'Please complete the experiment first.';
                correctCountEl.textContent = 'N/A';
                wrongCountEl.textContent = 'N/A';
                averageReactionTimeEl.textContent = 'N/A';
                taskAdvice.textContent = 'Please complete the experiment first.';
            }

            // Display Drawing Prediction Results
            async function displayDrawingResults(experimentData) {
                if (!experimentData.drawingData) {
                    drawingPrediction.textContent = 'No drawing data available.';
                    drawingAdvice.textContent = 'Please complete the drawing task first.';
                    return;
                }

                try {
                    // Load the trained model
                    const model = await tf.loadLayersModel('model/model.json'); // Ensure the path is correct

                    // Preprocess the drawing image
                    const img = new Image();
                    img.src = experimentData.drawingData; // Assuming drawingData is a base64 image string
                    img.onload = async function () {
                        const tensor = tf.browser.fromPixels(img)
                            .resizeNearestNeighbor([224, 224]) // Adjust based on your model's input size
                            .toFloat()
                            .expandDims();
                        const normalized = tensor.div(255.0); // Normalize as per training

                        // Make prediction
                        const prediction = model.predict(normalized);
                        const predictedClass = prediction.argMax(1).dataSync()[0]; // Assuming classification

                        // Map prediction to meaningful text
                        const predictionText = mapPredictionToText(predictedClass);
                        drawingPrediction.textContent = predictionText;

                        // Provide advice based on prediction
                        const adviceText = getAdviceBasedOnPrediction(predictedClass);
                        drawingAdvice.textContent = adviceText;

                        // Optionally, display a chart (e.g., confidence scores)
                        // For simplicity, we'll show a dummy chart here
                        // Replace with actual data if available

                        // Example: Confidence scores (assuming 3 classes)
                        /*
                        const confidenceScores = prediction.dataSync();
                        new Chart(drawingChartCtx, {
                            type: 'pie',
                            data: {
                                labels: ['No Alzheimer\'s', 'Mild Cognitive Impairment', 'Alzheimer\'s Disease'],
                                datasets: [{
                                    data: confidenceScores,
                                    backgroundColor: [
                                        '#28a745',
                                        '#ffc107',
                                        '#dc3545'
                                    ],
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Drawing Analysis Confidence Scores'
                                    }
                                }
                            },
                        });
                        */
                    };

                } catch (error) {
                    console.error('Error processing drawing:', error);
                    drawingPrediction.textContent = 'An error occurred during analysis.';
                    drawingAdvice.textContent = 'Please try again or contact support.';
                }
            }

            // Map Prediction to Meaningful Text
            function mapPredictionToText(prediction) {
                const predictionMap = {
                    0: 'No Alzheimer\'s Detected',
                    1: 'Mild Cognitive Impairment',
                    2: 'Alzheimer\'s Disease Detected'
                    // Adjust based on your model's output classes
                };
                return predictionMap[prediction] || 'Unknown';
            }

            // Provide Advice Based on Prediction
            function getAdviceBasedOnPrediction(prediction) {
                switch (prediction) {
                    case 0:
                        return 'Your drawing patterns are normal.';
                    case 1:
                        return 'There are signs of mild cognitive impairment. Consider consulting a healthcare professional.';
                    case 2:
                        return 'Indicators suggest possible Alzheimer\'s disease. Please consult a medical professional for a comprehensive evaluation.';
                    default:
                        return 'Unable to provide advice at this time.';
                }
            }

            // Display Task Performance Results
            function displayTaskResults(experimentData) {
                const trials = experimentData.trials || [];

                const correctCount = trials.filter(trial => trial.reactionTime !== null && trial.gazeData.length > 0).length;
                const wrongCount = trials.length - correctCount;

                correctCountEl.textContent = correctCount;
                wrongCountEl.textContent = wrongCount;

                // Compute Average Reaction Time
                const reactionTimes = trials
                    .filter(trial => trial.reactionTime !== null)
                    .map(trial => trial.reactionTime);
                const averageReactionTime = reactionTimes.length > 0
                    ? Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length)
                    : 0;
                averageReactionTimeEl.textContent = averageReactionTime;

                // Provide advice based on performance
                const taskAdviceText = getTaskAdvice(correctCount, wrongCount, averageReactionTime);
                taskAdvice.textContent = taskAdviceText;

                // Display a Chart for Correct vs Incorrect Answers
                new Chart(taskChartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Correct', 'Incorrect'],
                        datasets: [{
                            data: [correctCount, wrongCount],
                            backgroundColor: [
                                '#28a745',
                                '#dc3545'
                            ],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Task Performance: Correct vs Incorrect Answers'
                            }
                        }
                    },
                });
            }

            // Provide Advice Based on Task Performance
            function getTaskAdvice(correct, wrong, avgRT) {
                if (correct > wrong && avgRT < 3000) { // Thresholds can be adjusted
                    return 'Excellent performance! Your task metrics indicate healthy cognitive function.';
                } else if (correct >= wrong && avgRT < 5000) {
                    return 'Good performance. However, consider monitoring your cognitive health regularly.';
                } else {
                    return 'Your task performance shows potential signs of cognitive impairment. It is recommended to consult a healthcare professional.';
                }
            }

            // Optionally, display a combined chart
            /*
            function displayCombinedChart(drawingData, taskData) {
                // Implement combined chart logic if needed
            }
            */

            // Ensure data is saved when the page is unloaded
            window.addEventListener('beforeunload', function (e) {
                // Implement data saving logic here, such as sending data to a server
                // For example, you can clear the localStorage if desired
                // localStorage.removeItem('experimentData');
            });
        </script>
    </body>
</html>
